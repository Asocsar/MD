#  READING CREDSCO.CSV. NOTE: Change the path of the file for the proper one in your computer

#Note: Take care to use "/" fo the directory file. "\" provides errors

```{r}
path <- "path.txt"
path <- readChar(path, file.info(path)$size)
setwd(path) #set the working directory
setwd("C:/Users/Daniel Cano/Desktop/MD/D2") #set the working directory

dd <- read.table("clean_table.csv",header=T, sep=",");

dd
```


```{r}
#start substituting the structural missing values.
#with remaining, impute: Knn, MIMMI, MICE (multiple imputation, only if you know well)

# IMPUTATION By THE 1NN

library(class)

# FOR EVERY INDIVIDUAL WITH MISSING Incomes LOOK FOR THE MOST SIMILAR INDIVIDUAL 
# wrt REMAINING VARIABLES AND COPY THE VALUE OF INGRESSOS ON THE FIRST 
#For more robustness average the values of k-NN in general (with small k)


# For a single variable:
# Build an artificial matrix with the full numerical variables

dd_num <- data.frame(x1 = 1:dim(dd)[1])
for (k in names(dd)) {
  if (is.numeric(dd[,k][0])) {
    dd_num[k] <- dd[,k]
    k
  }
}


drops <- c("x1", "Open_GL", "Shader")
Core_Speed <- dd_num$Core_Speed
dd_num <- dd_num[ , !(names(dd_num) %in% drops)]


dd_num <- dd_num[complete.cases(dd_num[, 3:dim(dd_num)[2]]),]
dd_num <- dd_num[complete.cases(dd_num[, 1]),]
sum(is.na(dd_num$Core_Speed))

```

```{r}
# dim(dd_num)
# names(dd_num)
# divide in rows that had missing incomes or not on the target variable to be imputed
si_core_Speed <- dd_num[!is.na(Core_Speed),]
# dim(si_core_Speed)
no_core_Speed <- dd_num[is.na(Core_Speed),]
# dim(no_core_Speed)

knn.ing = knn(si_core_Speed,no_core_Speed,Core_Speed[!is.na(Core_Speed)])
```

```{r}
#CARE: neither aux1 nor aux2 can contain NAs


#CARE: knn.ing is generated as a factor. 
#Be sure to retrieve the correct values

IngresosOriginal<-Ingresos
Ingresos[is.na(Ingresos)] <- as.numeric(levels(knn.ing))


hist(IngresosOriginal)
summary(IngresosOriginal)

hist(Ingresos)
summary(Ingresos)

#For several Variables: 

#built indexes of numerical variables that require inputation

#Cargas.patrimoniales (12), patrimoni (11), Ingressos (10)
uncompleteVars<-c(10,11,12)

#better if you sort them by increasing number of missing values

fullVariables<-c(2,4,5,9,13,14)
aux<-dd[,fullVariables]
dim(aux)
names(aux)

for (k in uncompleteVars){
  aux1 <- aux[!is.na(dd[,k]),]
  dim(aux1) 
  aux2 <- aux[is.na(dd[,k]),]
  dim(aux2)
  
  RefValues<- dd[!is.na(dd[,k]),k]
  #Find nns for aux2
  knn.values = knn(aux1,aux2,RefValues)   
  
  #CARE: neither aux1 nor aux2 can contain NAs
  
  
  #CARE: knn.ing is generated as a factor. 
  #Be sure to retrieve the correct values
  
  dd[is.na(dd[,k]),k] = as.numeric(as.character(knn.values))
  fullVariables<-c(fullVariables, k)
  aux<-dd[,fullVariables]
}

dim(dd)
summary(dd)

#knowledge-based Inputation 

#MIMMI method?





#check for outliers
#how?


#Transformations? In General avoid


# Creation of new derived VARIABLES: “FEATURE EXTRACTION”

# RATIO OF FINANCEMENT 

Rati_fin = 100*Importe.solicitado/Precio.del.bien.financiado

hist(Rati_fin)

# CAPACITY TO SAVE

Estalvi <- (Ingresos-Gastos-(Cargas.patrimoniales/100))/(Importe.solicitado/Plazo)

hist(Estalvi)




# SAVING THE TRANSFORMATIONS IN A INTERNAL R FILE

save.image("credsco_bin")

names(dd)
dd[,15]<-Estalvi
dd[,16]<-Rati_fin
names(dd)[15]<-"Estalvi"
colnames(dd)[16]<-"RatiFin"


#saving the dataframe in an external file
write.table(dd, file = "credscoClean.csv", sep = ";", na = "NA", dec = ".", row.names = FALSE, col.names = TRUE)
```